<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ScaleX Marketing Dashboard</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- D3.js -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <!-- D3 Sankey -->
  <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>

  <!-- D3 Chord -->
  <script src="https://d3js.org/d3-chord.v1.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

  <style>
    body { font-family: system-ui, Arial; background:#f6f8fb; padding:25px; }
    h1 { margin-bottom:10px; }
    .container { max-width:1250px; margin:auto; }

    .controls { display:flex; gap:12px; align-items:center; margin-bottom:25px; }

    input, select {
      padding:6px;
      border-radius:6px;
      border:1px solid #ccc;
    }

    .row { display:flex; flex-wrap:wrap; gap:20px; margin-bottom:30px; }

    .card {
      background:white;
      border-radius:10px;
      padding:15px;
      flex:1 1 380px;
      min-width:360px;
      box-shadow:0 6px 18px rgba(16,24,40,0.06);
    }

    canvas { width:100% !important; height:300px !important; }
  </style>
</head>

<body>
<div class="container">

  <h1>ScaleX Marketing Dashboard</h1>

  <div class="controls">
    <label>Start: <input type="date" id="startDate"></label>
    <label>End: <input type="date" id="endDate"></label>

    <label>Device:
      <select id="deviceFilter">
        <option value="all">All</option>
        <option value="mobile">Mobile</option>
        <option value="desktop">Desktop</option>
      </select>
    </label>

    <label>Region:
      <input type="text" id="regionFilter" placeholder="e.g., IN">
    </label>

    <label>Channel Filter:
      <input type="text" id="channelFilter" placeholder="comma-separated e.g., google,meta">
    </label>

    <button id="refreshAll">Refresh</button>
  </div>

  <!-- ROW 1 -->
  <div class="row">
    <div class="card"><h3>Lead Count</h3><canvas id="leadCount"></canvas></div>
    <div class="card"><h3>Sessions Over Time</h3><canvas id="sessionsOverTime"></canvas></div>
  </div>

  <!-- ROW 2 -->
  <div class="row">
    <div class="card"><h3>Sessions by Channel</h3><canvas id="sessionsByChannel"></canvas></div>
    <div class="card"><h3>Leads by Campaign</h3><canvas id="leadsByCampaign"></canvas></div>
  </div>

  <!-- ROW 3 -->
  <div class="row">
    <div class="card"><h3>Source / Medium Mix</h3><canvas id="sourceMediumPie"></canvas></div>
    <div class="card">
      <h3>Top Landing Pages</h3>
      <table>
        <thead><tr><th>Landing Page</th><th>Sessions</th></tr></thead>
        <tbody id="landingPagesBody"></tbody>
      </table>
    </div>
  </div>

  <h2 style="margin-top:40px;">Multi-Channel Behaviour</h2>

  <!-- HEATMAP -->
  <div class="row">
    <div class="card" style="min-width:550px;">
      <h3>Audience Overlap (Heatmap)</h3>
      <div id="heatmapChart"></div>
    </div>
  </div>

  <!-- SANKEY -->
  <div class="row">
    <div class="card" style="min-width:550px;">
      <h3>First-Touch â†’ Lead-Touch Flow (Sankey)</h3>
      <svg id="sankeyChart" width="600" height="450"></svg>
    </div>
  </div>

  <!-- CHORD -->
  <div class="row">
    <div class="card" style="min-width:550px;">
      <h3>Channel Assist Score (Chord Diagram)</h3>
      <svg id="chordChart" width="550" height="550"></svg>
    </div>
  </div>

</div>


<script>

const API = "https://scalex-adapter-268453003438.europe-west1.run.app";


// -----------------------------------------
// ðŸ§  Helper â€” Build POST Request Payload
// -----------------------------------------
function buildPayload(chartName) {
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;

  const device = document.getElementById("deviceFilter").value;
  const region = document.getElementById("regionFilter").value;
  const channelCSV = document.getElementById("channelFilter").value.trim();

  const filters = {
    device: device,
    region: region || null,
    channel: channelCSV ? channelCSV.split(",").map(s => s.trim()) : null
  };

  return {
    chartName,
    dateRange: {
      startDate: start,
      endDate: end
    },
    comparison: false,
    filters,
    timestamp: new Date().toISOString()
  };
}


// -----------------------------------------
// ðŸ§  Helper â€” POST to Backend
// -----------------------------------------
async function fetchChart(chartName) {
  const payload = buildPayload(chartName);

  const res = await fetch(`${API}/chart-data`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload)
  });

  const json = await res.json();
  return json.data ? json.data.primary : [];
}


// -----------------------------------------
// ðŸŸ¦ Chart.js â€” Time Series Helper
// -----------------------------------------
function normalizeDay(d) {
  if (!d) return "";
  if (typeof d === "object" && d.value) return d.value;
  return d;
}

let leadChart, sessionsChart, bar1, bar2, pieChart;


// -----------------------------------------
// 1ï¸âƒ£ Lead Count
// -----------------------------------------
async function loadLeadCount(){
  const rows = await fetchChart("lead_count");
  const data = rows.map(r => ({day: normalizeDay(r.day), value: r.leads}));

  const ctx = document.getElementById("leadCount");
  if (leadChart) leadChart.destroy();

  leadChart = new Chart(ctx, {
    type:"line",
    data:{ labels:data.map(r=>r.day),
           datasets:[{label:"Leads", data:data.map(r=>r.value), fill:true}] }
  });
}


// -----------------------------------------
// 2ï¸âƒ£ Sessions Over Time
// -----------------------------------------
async function loadSessionsOverTime(){
  const rows = await fetchChart("sessions_over_time");

  const data = rows.map(r => ({day: normalizeDay(r.day), value: r.sessions}));

  const ctx = document.getElementById("sessionsOverTime");
  if (sessionsChart) sessionsChart.destroy();

  sessionsChart = new Chart(ctx, {
    type:"line",
    data:{ labels:data.map(r=>r.day),
           datasets:[{label:"Sessions", data:data.map(r=>r.value)}] }
  });
}


// -----------------------------------------
// 3ï¸âƒ£ Sessions by Channel
// -----------------------------------------
async function loadSessionsByChannel(){
  const rows = await fetchChart("sessions_by_channel");

  const data = rows.map(r => ({key:r.channel, value:r.sessions}));

  const ctx = document.getElementById("sessionsByChannel");
  if (bar1) bar1.destroy();

  bar1 = new Chart(ctx, {
    type:"bar",
    data:{ labels:data.map(r=>r.key),
           datasets:[{data:data.map(r=>r.value)}] },
    options:{ indexAxis:"y" }
  });
}


// -----------------------------------------
// 4ï¸âƒ£ Leads by Campaign
// -----------------------------------------
async function loadLeadsByCampaign(){
  const rows = await fetchChart("leads_by_campaign");

  const data = rows.map(r => ({key:r.campaign, value:r.leads}));

  const ctx = document.getElementById("leadsByCampaign");
  if (bar2) bar2.destroy();

  bar2 = new Chart(ctx, {
    type:"bar",
    data:{ labels:data.map(r=>r.key),
           datasets:[{data:data.map(r=>r.value)}] },
    options:{ indexAxis:"y" }
  });
}


// -----------------------------------------
// 5ï¸âƒ£ Source / Medium Pie
// -----------------------------------------
async function loadSourceMediumPie() {
  const rows = await fetchChart("source_medium_pie");

  const ctx = document.getElementById("sourceMediumPie");
  if (pieChart) pieChart.destroy();

  pieChart = new Chart(ctx, {
    type: "pie",
    data: {
      labels: rows.map(r => r.label),
      datasets: [{ data: rows.map(r => r.value) }]
    }
  });
}


// -----------------------------------------
// 6ï¸âƒ£ Top Landing Pages
// -----------------------------------------
async function loadTopLandingPages(){
  const rows = await fetchChart("top_landing_pages");

  const body = document.getElementById("landingPagesBody");
  body.innerHTML = "";

  rows.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r.landing_page}</td><td>${r.sessions}</td>`;
    body.appendChild(tr);
  });
}


// -----------------------------------------------------------
// ADVANCED MULTI-CHANNEL CHARTS
// -----------------------------------------------------------


// -----------------------------------------
// ðŸ”¥ 7ï¸âƒ£ Audience Overlap Heatmap
// -----------------------------------------
async function loadAudienceOverlap() {
  const rows = await fetchChart("audience_overlap");

  const container = d3.select("#heatmapChart");
  container.selectAll("*").remove();

  const channels = [...new Set(rows.flatMap(r => [r.channel_a, r.channel_b]))];
  const size = channels.length;

  const matrix = Array.from({length:size}, (_,i) =>
    Array.from({length:size}, (_,j) => {
      const hit = rows.find(r => r.channel_a === channels[i] && r.channel_b === channels[j]);
      return hit ? hit.users : 0;
    })
  );

  const width = 500, height = 500;
  const grid = width / size;

  const svg = container.append("svg")
    .attr("width", width + 120)
    .attr("height", height + 120)
    .append("g")
    .attr("transform", "translate(80,40)");

  const color = d3.scaleSequential(d3.interpolateOrRd)
    .domain([0, d3.max(matrix.flat())]);

  // Labels
  channels.forEach((ch,i)=>{
    svg.append("text")
      .attr("x", i * grid + grid/2)
      .attr("y", -5)
      .attr("text-anchor","middle")
      .text(ch);

    svg.append("text")
      .attr("x", -5)
      .attr("y", i * grid + grid/2)
      .attr("text-anchor","end")
      .attr("dominant-baseline","middle")
      .text(ch);
  });

  // Cells
  matrix.forEach((row,i)=>{
    row.forEach((val,j)=>{
      svg.append("rect")
        .attr("x", j*grid)
        .attr("y", i*grid)
        .attr("width", grid)
        .attr("height", grid)
        .attr("fill", color(val));

      svg.append("text")
        .attr("x", j*grid + grid/2)
        .attr("y", i*grid + grid/2)
        .attr("text-anchor","middle")
        .attr("dominant-baseline","middle")
        .attr("fill","black")
        .text(val);
    });
  });
}


// -----------------------------------------
// ðŸ”¥ 8ï¸âƒ£ First-Touch â†’ Lead-Touch Sankey
// -----------------------------------------
async function loadSankey() {
  const rows = await fetchChart("first_to_last_touch");

  const nodes = {};
  rows.forEach(r => {
    nodes[r.first_channel] = 1;
    nodes[r.lead_channel] = 1;
  });

  const nodeList = Object.keys(nodes).map(name => ({ name }));
  const index = Object.fromEntries(nodeList.map((n,i)=>[n.name,i]));

  const links = rows.map(r => ({
    source: index[r.first_channel],
    target: index[r.lead_channel],
    value: r.users
  }));

  const svg = d3.select("#sankeyChart");
  svg.selectAll("*").remove();

  const width = 600, height = 450;

  const sankey = d3.sankey()
    .nodeWidth(20)
    .nodePadding(20)
    .extent([[1,1], [width-1, height-5]]);

  const graph = sankey({
    nodes: nodeList.map(n => ({...n})),
    links
  });

  svg.append("g")
    .selectAll("rect")
    .data(graph.nodes)
    .join("rect")
    .attr("x", d=>d.x0)
    .attr("y", d=>d.y0)
    .attr("height", d=>d.y1-d.y0)
    .attr("width", d=>d.x1-d.x0)
    .attr("fill","steelblue");

  svg.append("g")
    .selectAll("path")
    .data(graph.links)
    .join("path")
    .attr("d", d3.sankeyLinkHorizontal())
    .attr("stroke","#aaa")
    .attr("stroke-width", d=>Math.max(1,d.width))
    .attr("fill","none");

  svg.append("g")
    .selectAll("text")
    .data(graph.nodes)
    .join("text")
    .attr("x", d => d.x0 < width/2 ? d.x1 + 6 : d.x0 - 6)
    .attr("y", d => (d.y0 + d.y1) / 2)
    .attr("dy","0.35em")
    .attr("text-anchor", d => d.x0 < width/2 ? "start" : "end")
    .text(d => d.name);
}


// -----------------------------------------
// ðŸ”¥ 9ï¸âƒ£ Channel Assist Chord Diagram
// -----------------------------------------
async function loadChord() {
  const rows = await fetchChart("channel_assists");

  const channels = [...new Set(rows.flatMap(r => [r.assist_channel, r.conversion_channel]))];

  const size = channels.length;
  const index = Object.fromEntries(channels.map((c,i)=>[c,i]));

  const matrix = Array.from({length:size}, ()=>Array(size).fill(0));

  rows.forEach(r => {
    matrix[index[r.assist_channel]][index[r.conversion_channel]] = r.assists;
  });

  const width = 550, height = 550;
  const outerRadius = width/2 - 30;
  const innerRadius = outerRadius - 20;

  const svg = d3.select("#chordChart");
  svg.selectAll("*").remove();

  const g = svg
    .attr("viewBox",[0,0,width,height])
    .append("g")
    .attr("transform",`translate(${width/2},${height/2})`);

  const chord = d3.chord().padAngle(0.05).sortSubgroups(d3.descending);
  const arcs = chord(matrix);

  const color = d3.scaleOrdinal(d3.schemeTableau10);

  g.append("g")
    .selectAll("path")
    .data(arcs.groups)
    .join("path")
    .attr("fill", d=>color(d.index))
    .attr("d", d3.arc().innerRadius(innerRadius).outerRadius(outerRadius));

  g.append("g")
    .selectAll("text")
    .data(arcs.groups)
    .join("text")
    .attr("transform", d=>{
      const a = (d.startAngle + d.endAngle)/2;
      return `rotate(${a*180/Math.PI - 90}) translate(${outerRadius + 5})`;
    })
    .attr("dy","0.35em")
    .attr("text-anchor","start")
    .text(d => channels[d.index]);

  g.append("g")
    .attr("fill-opacity",0.7)
    .selectAll("path")
    .data(arcs)
    .join("path")
    .attr("d", d3.ribbon().radius(innerRadius))
    .attr("fill", d=>color(d.target.index))
    .attr("stroke","#333");
}


// -----------------------------------------
// ðŸ”„ REFRESH ALL
// -----------------------------------------
async function refreshDashboard() {
  await Promise.all([
    loadLeadCount(),
    loadSessionsOverTime(),
    loadSessionsByChannel(),
    loadLeadsByCampaign(),
    loadSourceMediumPie(),
    loadTopLandingPages(),
    loadAudienceOverlap(),
    loadSankey(),
    loadChord()
  ]);
}

document.getElementById("refreshAll").addEventListener("click", refreshDashboard);

// Auto-fill default date range (last 30 days)
(function initDates() {
  const end = new Date();
  const start = new Date();
  start.setDate(start.getDate() - 30);

  document.getElementById("startDate").value = start.toISOString().slice(0,10);
  document.getElementById("endDate").value = end.toISOString().slice(0,10);

  refreshDashboard();
})();
</script>

</body>
</html>
